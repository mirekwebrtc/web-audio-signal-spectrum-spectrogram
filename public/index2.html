<!DOCTYPE html>
<html>
<head>
    <title>Web audio: Filter Playground</title>
    <!-- Bootstrap -->
    <link href="css/bootstrap.css" rel="stylesheet"/>
    <link href="css/ui-lightness/jquery-ui-1.9.1.custom.css" rel="stylesheet"/>
</head>
<body>

<div class="container">

    <h1 class="pagination-centered">Web audio: Filter Playground</h1>

    <ul class="nav nav-list">
        <li class="divider"></li>
    </ul>

    <div class="row">
    </div>

    <div class="row" style="background-color: #eeeeee">

        <div class="span3">
            <h3>1. Enable inputs:</h3>

            <div class="row">
                <div class="span1"><span>Music:</span></div>
                <div class="span2">
                    <div class="btn-toolbar" style="margin-top: -7px; margin-left: 10px">
                        <div class="btn-group">
                            <a class="btn btn-primary" id="music-start" href="#"><i id="music-start-icon"
                                                                                    class="icon-play icon-white"></i></a>
                            <a class="btn btn-primary disabled" id="music-stop" href="#"><i id="music-stop-icon"
                                                                                            class="icon-stop icon-white"></i></a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="span1"><span>Microphone:</span></div>
                <div class="span2">
                    <div class="btn-toolbar" style="margin-top: -7px; margin-left: 10px">
                        <div class="btn-group">
                            <a class="btn btn-primary" id="mic-start" href="#"><i id="mic-start-icon"
                                                                                  class="icon-play icon-white"></i></a>
                            <a class="btn btn-primary disabled" id="mic-stop" href="#"><i id="mic-stop-icon"
                                                                                          class="icon-stop icon-white"></i></a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="span1"><span>Triangle:</span></div>
                <div class="span2">
                    <div class="btn-toolbar" style="margin-top: -7px; margin-left: 10px">
                        <div class="btn-group">
                            <a class="btn btn-primary" id="sq-start" href="#"><i id="sq-start-icon"
                                                                                 class="icon-play icon-white"></i></a>
                            <a class="btn btn-primary disabled" id="sq-stop" href="#"><i id="sq-stop-icon"
                                                                                         class="icon-stop icon-white"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="span6">

        </div>
        <div class="span3">
            <h3>3. Enable outputs</h3>
            <div class="row">
                <div class="span1"><span>Speaker:</span></div>
                <div class="span2">
                    <div class="btn-toolbar" style="margin-top: -7px; margin-left: 10px">
                        <div class="btn-group">
                            <a class="btn btn-primary" id="spk-start" href="#"><i id="spk-start-icon"
                                                                                  class="icon-play icon-white"></i></a>
                            <a class="btn btn-primary disabled" id="spk-stop" href="#"><i id="spk-stop-icon"
                                                                                          class="icon-stop icon-white"></i></a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="span1"><span>Frequencies:</span></div>
                <div class="span2">
                    <div class="btn-toolbar" style="margin-top: -7px; margin-left: 10px">
                        <div class="btn-group">
                            <a class="btn btn-primary" id="freq-start" href="#"><i id="freq-start-icon"
                                                                                   class="icon-play icon-white"></i></a>
                            <a class="btn btn-primary disabled" id="freq-stop" href="#"><i id="freq-stop-icon"
                                                                                           class="icon-stop icon-white"></i></a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="span1"><span>Spectrogram:</span></div>
                <div class="span2">
                    <div class="btn-toolbar" style="margin-top: -7px; margin-left: 10px">
                        <div class="btn-group">
                            <a class="btn btn-primary" id="spectro-start" href="#"><i id="spectro-start-icon"
                                                                                      class="icon-play icon-white"></i></a>
                            <a class="btn btn-primary disabled" id="spectro-stop" href="#"><i id="spectro-stop-icon"
                                                                                              class="icon-stop icon-white"></i></a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="span1"><span>Wave:</span></div>
                <div class="span2">
                    <div class="btn-toolbar" style="margin-top: -7px; margin-left: 10px">
                        <div class="btn-group">
                            <a class="btn btn-primary" id="wave-start" href="#"><i id="wave-start-icon"
                                                                                   class="icon-play icon-white"></i></a>
                            <a class="btn btn-primary disabled" id="wave-stop" href="#"><i id="wave-stop-icon"
                                                                                           class="icon-stop icon-white"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-list">
        <li class="divider"></li>
    </ul>

    <div class="row" style="background-color: #eeeeee; padding-top: 10px; padding-bottom: 10px">
        <div class="row">
            <div class="span12"><h3 style="margin-left: 20px">4. View the output:</h3></div>
        </div>
        <div class="row">
            <div class="span4 " >
                Frequencies:
                <canvas id="spectrum" width="300" height="256"
                        style="display: block; background-color: black ;"></canvas>
            </div>
            <div class="span4 ">
                Spectrogram:
                <canvas id="spectrogram" width="300" height="256"
                        style="display: block; background-color: black ;"></canvas>
            </div>
            <div class="span4">
                Waveform:
                <canvas id="wave" width="300" height="256"
                        style="display: block; background-color: black ;"></canvas>
            </div>

        </div>
    </div>

    <ul class="nav nav-list">
        <li class="divider"></li>
    </ul>
</div>

<script src="js/jquery-1.8.2.js"></script>
<script src="js/jquery-ui-1.9.1.custom.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/chroma.js"></script>
<script>

    // some globals
    var context = new AudioContext();
    var audioBuffer;
    var sourceNode;
    var mediaStreamSource;

    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;


    var osc = context.createOscillator();

    var filter = context.createBiquadFilter();
    filter.type = 3;
    filter.frequency.value = 440;
    filter.Q.value = 0;
    filter.gain.value = 0;


    // state variables
    var analyserRunning = false;
    var spectrumRunning = false;
    var waveRunning = false;
    var musicRunning = false;
    var micRunning = false;
    var sqRunning = false;

    // setup a javascript node
    var javascriptNode = context.createScriptProcessor(2048, 1, 1);

    // connect to destination, else it isn't called
    javascriptNode.connect(context.destination);
    // when the javascript node is called
    // we use information from the analyzer node
    // to draw the volume
    javascriptNode.onaudioprocess = function () {

        // get the average for the first channel
        var array = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(array);

        // draw the spectrogram
        if ((musicRunning || micRunning || sqRunning)
                && analyserRunning) {
            drawSpectrogram(array);
        }

        if ((musicRunning || micRunning || sqRunning)
                && spectrumRunning) {
            drawSpectrum(array);
        }

        if ((musicRunning || micRunning || sqRunning)
                && waveRunning) {
            var array2 = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteTimeDomainData(array2)


            drawWave(array2);
        }



    }

    // setup a analyzer
    var analyser = context.createAnalyser();
    analyser.smoothingTimeConstant = 0;
    analyser.fftSize = 512;

    // create a buffer source node
    filter.connect(analyser);
    analyser.connect(javascriptNode);

    // get the context from the canvas to draw on
    var ctx = $("#spectrogram").get()[0].getContext("2d");

    // create a temp canvas we use for copying
    var tempCanvas = document.createElement("canvas");
    tempCanvas.width = 460;
    tempCanvas.height = 300;
    var tempCtx = tempCanvas.getContext("2d");

    // used for color distribution
    var hot = new chroma.ColorScale({
        colors:['#000000', '#ff0000', '#ffff00', '#ffffff'],
        positions:[0, .25, .75, 1],
        mode:'rgb',
        limits:[0, 350]
    });

    $(document).ready(function () {
        setupHandlers();
        loadSound("wagner-short.ogg");
    });

    function setupSourceAudio() {
        // create a buffer source node
        sourceNode = context.createBufferSource();

        sourceNode.connect(filter);
        //filter.connect(context.destination);

        // and connect to destination
        //sourceNode.connect(context.destination);
    }

    function setupHandlers() {
        $("#music-start").click(function () {
            setupSourceAudio();
            sourceNode.buffer = audioBuffer;
            sourceNode.start(0);
            sourceNode.loop = true;
            musicRunning=true;

            $("#music-start").addClass("disabled");
            $("#music-stop").removeClass("disabled");

        });

        $("#music-stop").click(function () {
            sourceNode.stop(0);

            musicRunning = false;
            $("#music-stop").addClass("disabled");
            $("#music-start").removeClass("disabled");
        });

        $("#sq-start").click(function () {
            osc.frequency.value=600;
            osc.type=2;
            osc.connect(filter);
            osc.start(0);


            sqRunning=true;

            $("#sq-stop").removeClass("disabled");
            $("#sq-start").addClass("disabled");
        });

        $("#sq-stop").click(function () {
            osc.stop(0);
            osc.disconnect(filter);

            sqRunning=false;

            $("#sq-stop").addClass("disabled");
            $("#sq-start").removeClass("disabled");
        });


        $("#mic-start").click(function () {
//        navigator.webkitGetUserMedia({audio:true},function(stream) {
            navigator.getUserMedia({audio:true},function(stream) {
                mediaStreamSource = context.createMediaStreamSource(stream);
                mediaStreamSource.connect(filter);

                micRunning = true;
                $("#mic-start").addClass("disabled");
                $("#mic-stop").removeClass("disabled");
            }, function(fail) {console.log(fail)});



        });

        $("#mic-stop").click(function () {
            mediaStreamSource.disconnect(filter);
            micRunning = false;


            $("#mic-stop").addClass("disabled");
            $("#mic-start").removeClass("disabled");
        });




        $("#spectro-start").click(function () {

            analyserRunning = true;

            $("#spectro-start").addClass("disabled");
            $("#spectro-stop").removeClass("disabled");
        });

        $("#spectro-stop").click(function () {
            analyserRunning = false;

            $("#spectro-start").removeClass("disabled");
            $("#spectro-stop").addClass("disabled");
        });

        $("#freq-start").click(function() {

            spectrumRunning = true;
            $("#freq-start").addClass("disabled");
            $("#freq-stop").removeClass("disabled");

        });

        $("#freq-stop").click(function() {

            spectrumRunning = false;
            $("#freq-start").removeClass("disabled");
            $("#freq-stop").addClass("disabled");
        });


        $("#wave-start").click(function() {

            waveRunning = true;
            $("#wave-start").addClass("disabled");
            $("#wave-stop").removeClass("disabled");

        });

        $("#wave-stop").click(function() {

            waveRunning = false;
            $("#wave-start").removeClass("disabled");
            $("#wave-stop").addClass("disabled");
        });

        $("#spk-start").click(function() {

            filter.connect(context.destination);
            $("#spk-start").addClass("disabled");
            $("#spk-stop").removeClass("disabled");

        });

        $("#spk-stop").click(function() {

            filter.disconnect(context.destination);
            filter.connect(analyser);
            $("#spk-start").removeClass("disabled");
            $("#spk-stop").addClass("disabled");
        });



    }


    // load the specified sound
    function loadSound(url) {
        var request = new XMLHttpRequest();
        request.open('GET', url, true);
        request.responseType = 'arraybuffer';

        // When loaded decode the data
        request.onload = function () {

            // decode the data
            context.decodeAudioData(request.response, function (buffer) {
                // when the audio is decoded play the sound
                audioBuffer = buffer;
            }, onError);
        }
        request.send();
    }

    function playSound(buffer) {
        sourceNode.buffer = buffer;
        sourceNode.noteOn(0);
    }

    // log if an error occurs
    function onError(e) {
        console.log(e);
    }

    function drawSpectrum(array) {
        var ctx = $("#spectrum").get()[0].getContext("2d");
        ctx.fillStyle = "#ffffff"
        ctx.clearRect(0, 0, 300, 256);


        for ( var i = 0; i < (array.length); i++ ){
            var value = array[i];

            ctx.fillRect(i*2,300-value,1,300);
        }
    };

    function drawWave(array) {

        var ctx = $("#wave").get()[0].getContext("2d");
        ctx.fillStyle = "#ffffff"
        ctx.clearRect(0, 0, 300, 256);

        for ( var i = 0; i < (array.length); i++ ){
            var value = array[i];

            ctx.fillRect(i+22,256-value,1,1);
        }
    };

    function drawSpectrogram(array) {

        // copy the current canvas onto the temp canvas
        var canvas = document.getElementById("spectrogram");

        tempCtx.drawImage(canvas, 0, 0, 300, 256);

        // iterate over the elements from the array
        for (var i = 0; i < array.length; i++) {
            // draw each pixel with the specific color
            var value = array[i];
            ctx.fillStyle = hot.getColor(value).hex();

            // draw the line at the right side of the canvas
            ctx.fillRect(300 - 1, 256 - i, 1, 1);
        }

        // set translate on the canvas
        ctx.translate(-1, 0);
        // draw the copied image
        ctx.drawImage(spectrogram, 0, 0, 300, 256, 0, 0, 300, 256);

        // reset the transformation matrix
        ctx.setTransform(1, 0, 0, 1, 0, 0);

    }

</script>
</body>
</html>
